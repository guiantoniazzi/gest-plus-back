USE DB_GEST_MAIS;

DROP PROCEDURE IF EXISTS VERIFICAR_LOGIN;

DELIMITER $$
CREATE PROCEDURE VERIFICAR_LOGIN(
	IN USUARIO VARCHAR(8),
    IN SENHA VARCHAR(30)
)
BEGIN
	SELECT USU.CD_USUARIO AS cdUsuario, 
		USU.CD_PESSOA AS cdPessoa, 
        UE.CD_EMPRESA AS cdEmpresa, 
        PE.NOME AS nome, 
        GROUP_CONCAT(FS.CD_FUNCAO SEPARATOR '|') AS cdFuncao 
	FROM USUARIO AS USU
    LEFT JOIN USUARIO_EMPRESA AS UE ON UE.CD_USUARIO = USU.CD_USUARIO
    LEFT JOIN PESSOA AS PE ON PE.CD_PESSOA = USU.CD_PESSOA
    LEFT JOIN PERFIL_ACESSO AS PA ON PA.CD_PERFIL = UE.CD_PERFIL
    LEFT JOIN FUNCOES_PERFIL AS FP ON FP.CD_PERFIL = PA.CD_PERFIL
    LEFT JOIN FUNCOES_SISTEMA AS FS ON FS.CD_FUNCAO = FP.CD_FUNCAO
    
    WHERE USU.CD_USUARIO = USUARIO AND USU.SENHA = SENHA AND USU.ATIVO = '1' 
		AND UE.ATIVO = '1' 
        AND PE.ATIVO = '1'
        AND PA.ATIVO = '1'
        AND FS.ATIVO = '1';

	/* SELECT 
    
    RIGHT JOIN USUARIO_EMPRESA AS UE ON UE.CD_PERFIL = PA.CD_PERFIL
    RIGHT JOIN USUARIO AS US ON US.CD_USUARIO = UE.CD_USUARIO
    WHERE FS.ATIVO = '1' AND US.ATIVO = '1' AND US.CD_USUARIO = USUARIO AND US.SENHA = SENHA;
	*/
END 
$$ DELIMITER ;